<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG ƒêƒÇNG K√ù T√çN CH·ªà DTU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1; --admin: #f43f5e; --bg-dark: #020617;
            --glass-bg: rgba(15, 23, 42, 0.95); --glass-border: rgba(255, 255, 255, 0.1);
        }
        body { background-color: var(--bg-dark); color: #f8fafc; font-family: 'Outfit', sans-serif; overflow-x: hidden; margin: 0; }
        #particles-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at bottom, #1e1b4b 0%, #020617 100%); }
        .glass { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative; z-index: 10; }
        .input-field { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem 1rem 1rem 3rem; color: white; outline: none; transition: all 0.3s ease; position: relative; z-index: 50; pointer-events: auto; }
        .input-field:focus { border-color: var(--primary); background: rgba(255, 255, 255, 0.1); }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; z-index: 51; pointer-events: none; }
        .btn-glow { background: linear-gradient(135deg, var(--primary), #8b5cf6); transition: all 0.3s; position: relative; overflow: hidden; cursor: pointer; z-index: 50; }
        .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.5); }
        .auth-container { overflow: hidden; position: relative; z-index: 20; }
        .form-slider { display: flex; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); width: 200%; }
        .form-slide { width: 50%; padding: 2rem; box-sizing: border-box; }
        .input-group { position: relative; margin-bottom: 1.2rem; z-index: 50; }
        .toast { position: fixed; top: 24px; right: 24px; transform: translate3d(150%, 0, 0); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 9999; border-left: 4px solid var(--primary); will-change: transform; }
        .toast.show { transform: translate3d(0, 0, 0); }
        .table-row { border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; cursor: pointer; }
        .table-row:hover { background: rgba(255,255,255,0.03); }
        /* Badge tr·∫°ng th√°i n√¢ng c·∫•p */
        .status-badge {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .st-success { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.4); }
        .st-process { background: rgba(56, 189, 248, 0.2); color: #7dd3fc; border: 1px solid rgba(56, 189, 248, 0.4); animation: pulse 2s infinite; }
        .st-error { background: rgba(244, 63, 94, 0.2); color: #fca5a5; border: 1px solid rgba(244, 63, 94, 0.4); }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.4); }
        .st-hanging {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            border: 1px solid rgba(251, 146, 60, 0.4);
            animation: flicker 1.8s infinite alternate;
        }
        .st-pending {
            background: rgba(234, 179, 8, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(234, 179, 8, 0.4);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes flicker { 0% { opacity: 0.8; } 100% { opacity: 1; } }
        .admin-bg { background: linear-gradient(135deg, var(--admin), #be123c) !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #welcome-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.4s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #welcome-modal.show {
            opacity: 1;
            visibility: visible;
        }
        #welcome-modal .modal-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #6366f1;
            border-radius: 24px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 30px 80px rgba(99, 102, 241, 0.6);
            overflow: hidden;
            animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <canvas id="particles-canvas"></canvas>
    <div id="toast" class="toast glass px-6 py-4 rounded-xl flex items-center gap-4 border border-white/10">
        <div id="toast-icon-bg" class="w-10 h-10 rounded-full flex items-center justify-center text-lg transition-colors duration-300"><i id="toast-icon" class="fa-solid fa-bell"></i></div>
        <div><h4 class="font-bold text-sm text-white" id="toast-title">Th√¥ng b√°o</h4><p class="text-xs text-gray-400" id="toast-msg">N·ªôi dung...</p></div>
    </div>
    <!-- Modal Ch√†o M·ª´ng -->
    <div id="welcome-modal">
        <div class="modal-content p-6 max-w-sm">
            <div class="flex justify-between items-start mb-5">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-bolt text-indigo-400 animate-pulse text-2xl"></i>
                    Ch√†o m·ª´ng ƒë·∫øn v·ªõi DTU TOOL
                </h3>
                <button onclick="closeWelcomeModal()" class="text-gray-400 hover:text-white text-2xl transition">√ó</button>
            </div>
            <div class="space-y-5 text-sm text-gray-300 leading-relaxed">
                <p class="flex items-center gap-2">
                    <span class="text-yellow-400 text-lg">üëë</span>
                    <strong>Admin: Ph·∫°m Ho√†ng V∆∞∆°ng</strong>
                </p>
                <div>
                    <p class="font-bold text-orange-400 mb-2 flex items-center gap-2">
                        <span class="text-lg">‚ö†Ô∏è</span> L∆ØU √ù QUAN TR·ªåNG
                    </p>
                    <ol class="list-decimal list-inside space-y-1 text-xs ml-1">
                        <li>Tool s·ª≠ d·ª•ng t√†i kho·∫£n MyDTU c·ªßa b·∫°n ƒë·ªÉ ƒëƒÉng k√Ω t·ª± ƒë·ªông.</li>
                        <li>Vui l√≤ng nh·∫≠p ƒë√∫ng t√†i kho·∫£n v√† m·∫≠t kh·∫©u DTU.</li>
                        <li>N·∫øu website tr∆∞·ªùng b·∫£o tr√¨, tool s·∫Ω t·ª± th·ª≠ l·∫°i sau.</li>
                        <li>Th√†nh c√¥ng ph·ª• thu·ªôc v√†o t·ªëc ƒë·ªô m·∫°ng v√† th·ªùi ƒëi·ªÉm ch·∫°y.</li>
                        <li>Admin kh√¥ng ch·ªãu tr√°ch nhi·ªám n·∫øu t√†i kho·∫£n b·ªã kh√≥a do vi ph·∫°m quy ƒë·ªãnh tr∆∞·ªùng.</li>
                    </ol>
                </div>
                <div>
                    <p class="font-bold text-green-400 mb-2 flex items-center gap-2">
                        <span class="text-lg">üîë</span> K√çCH HO·∫†T VIP
                    </p>
                    <p class="text-xs">T√†i kho·∫£n mi·ªÖn ph√≠ ch·ªâ xem th√¥ng tin.<br>ƒê·ªÉ d√πng tool t·ª± ƒë·ªông, c·∫ßn n√¢ng c·∫•p VIP.</p>
                    <p class="text-xs mt-2 font-semibold text-indigo-300">Li√™n h·ªá Admin:</p>
                    <div class="mt-2 space-y-2">
                        <a href="https://www.facebook.com/PhamHoangVngw" target="_blank" class="flex items-center gap-2 p-2 bg-white/5 rounded-lg hover:bg-white/10 transition text-xs">
                            <i class="fa-brands fa-facebook text-blue-500"></i>
                            <span>facebook.com/PhamHoangVngw</span>
                        </a>
                        <div onclick="copyZalo()" class="flex items-center gap-2 p-2 bg-white/5 rounded-lg hover:bg-white/10 transition cursor-pointer text-xs">
                            <i class="fa-solid fa-phone text-green-500"></i>
                            <span>0795616819 (Zalo) - Nh·∫•n ƒë·ªÉ copy</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex gap-3 justify-center">
                <button onclick="hideWelcomeFor2Hours()" class="px-5 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs font-bold text-white transition">
                    ·∫®n trong 2 ti·∫øng
                </button>
                <button onclick="closeWelcomeModal()" class="btn-glow px-8 py-2 rounded-lg text-sm font-bold text-white shadow-lg hover:scale-105 transition">
                    T√¥i ƒë√£ hi·ªÉu, b·∫Øt ƒë·∫ßu
                </button>
            </div>
        </div>
    </div>
    <!-- View Auth -->
    <div id="view-auth" class="flex-grow flex items-center justify-center p-4 relative z-10">
        <div class="glass w-full max-w-[420px] rounded-3xl overflow-hidden shadow-2xl relative">
            <div class="pt-8 px-8 pb-4 text-center">
                <div class="w-16 h-16 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-indigo-500/30"><i class="fa-solid fa-atom text-3xl text-white"></i></div>
                <h1 class="text-2xl font-bold tracking-tight text-white">DTU TOOL</h1>
                <div class="mt-6 bg-black/30 p-1 rounded-xl flex relative z-20">
                    <div id="tab-indicator" class="absolute w-[calc(50%-4px)] h-[calc(100%-8px)] bg-indigo-600 rounded-lg top-1 left-1 transition-all duration-300"></div>
                    <button onclick="switchAuthTab('login')" class="flex-1 py-2 text-sm font-semibold z-10 relative transition-colors duration-300 text-white cursor-pointer" id="btn-tab-login">ƒêƒÉng Nh·∫≠p</button>
                    <button onclick="switchAuthTab('register')" class="flex-1 py-2 text-sm font-semibold z-10 relative transition-colors duration-300 text-gray-400 cursor-pointer" id="btn-tab-register">ƒêƒÉng K√Ω</button>
                </div>
            </div>
            <div class="auth-container">
                <div class="form-slider" id="form-slider">
                    <div class="form-slide">
                        <form onsubmit="event.preventDefault(); handleLogin();">
                            <div class="input-group"><input type="text" id="login-user" class="input-field" placeholder="T√™n ƒëƒÉng nh·∫≠p..."><i class="fa-regular fa-user input-icon"></i></div>
                            <div class="input-group"><input type="password" id="login-pass" class="input-field" placeholder="M·∫≠t kh·∫©u..."><i class="fa-solid fa-lock input-icon"></i></div>
                            <button type="submit" class="btn-glow w-full py-3.5 rounded-xl font-bold text-white shadow-lg mt-2">TRUY C·∫¨P NGAY</button>
                        </form>
                    </div>
                    <div class="form-slide">
                        <form onsubmit="event.preventDefault(); handleRegister();">
                            <div class="input-group"><input type="text" id="reg-user" class="input-field" placeholder="T√™n t√†i kho·∫£n m·ªõi..."><i class="fa-regular fa-user input-icon"></i></div>
                            <div class="input-group"><input type="password" id="reg-pass" class="input-field" placeholder="M·∫≠t kh·∫©u..."><i class="fa-solid fa-lock input-icon"></i></div>
                            <button type="submit" class="btn-glow w-full py-3.5 rounded-xl font-bold text-white shadow-lg mt-2 bg-gradient-to-r from-teal-500 to-emerald-500">T·∫†O T√ÄI KHO·∫¢N</button>
                            <p class="text-[10px] text-gray-400 text-center mt-3">*ƒêƒÉng k√Ω ƒë·ªÉ xem b·∫£ng gi√° v√† d·ªãch v·ª•.</p>
                        </form>
                    </div>
                </div>
            </div>
            <div class="py-4 bg-black/20 text-center text-[10px] text-gray-500 relative z-20">H·ªá th·ªëng v2.7 - Tr·∫°ng th√°i "ƒêang b·ªã treo" m·ªõi</div>
        </div>
    </div>
    <!-- View Dashboard -->
    <div id="view-dashboard" class="hidden opacity-0 transition-opacity duration-700 min-h-screen flex flex-col relative z-10">
        <nav class="container mx-auto mt-4 px-4 relative z-20">
            <div class="glass rounded-2xl px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="nav-logo" class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg"><i class="fa-solid fa-layer-group"></i></div>
                    <div class="hidden sm:block"><h2 class="font-bold text-sm leading-tight text-white">DTU TOOL</h2><span id="nav-role" class="text-[10px] text-indigo-300 tracking-wider">KH√îNG GIAN L√ÄM VI·ªÜC</span></div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="greeting-text" class="text-xs text-gray-400">Xin ch√†o,</div><div id="display-name" class="text-sm font-bold text-white">User Name</div>
                        <div class="flex gap-2 justify-end mt-1"><span id="user-plan-badge"></span><span id="user-status-badge"></span></div>
                    </div>
                    <div class="h-8 w-[1px] bg-gray-700 mx-2"></div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-400 transition cursor-pointer" title="ƒêƒÉng xu·∫•t"><i class="fa-solid fa-right-from-bracket text-lg"></i></button>
                </div>
            </div>
        </nav>
        <main class="container mx-auto px-4 py-8 flex-grow relative z-10">
            <div id="client-panel" class="hidden">
                <div class="text-center mb-10" id="service-header">
                    <h1 class="text-3xl md:text-5xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">H·ªá Th·ªëng T·ª± ƒê·ªông H√≥a</h1>
                    <p class="text-gray-400 max-w-xl mx-auto">C√¥ng c·ª• h·ªó tr·ª£ sinh vi√™n ƒëƒÉng k√Ω t√≠n ch·ªâ si√™u t·ªëc.</p>
                </div>
                <div id="service-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto mb-10">
                    <div onclick="openToolModal()" class="glass p-1 rounded-3xl cursor-pointer hover:scale-[1.02] transition duration-300 group">
                        <div class="bg-[#0f172a]/90 p-6 rounded-[22px] h-full flex flex-col relative z-10">
                            <div class="w-14 h-14 rounded-2xl bg-indigo-600 flex items-center justify-center text-white text-2xl mb-4 shadow-lg shadow-indigo-600/20"><i class="fa-solid fa-bolt"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">ƒêƒÉng K√Ω T√≠n Ch·ªâ</h3><p class="text-sm text-gray-400 mb-6 flex-grow">Tool t·ª± ƒë·ªông login, gi·∫£i Captcha AI v√† sƒÉn l·ªõp.</p>
                            <div class="flex items-center justify-between border-t border-gray-700 pt-4"><span class="text-xs text-green-400 font-bold bg-green-400/10 px-2 py-1 rounded">VIP ONLY</span><i class="fa-solid fa-lock text-gray-500 group-hover:text-white transition"></i></div>
                        </div>
                    </div>
                    <div class="glass p-6 rounded-3xl opacity-50 grayscale cursor-not-allowed"><div class="w-14 h-14 rounded-2xl bg-gray-700 flex items-center justify-center text-white text-2xl mb-4"><i class="fa-solid fa-calendar-days"></i></div><h3 class="text-xl font-bold text-white mb-2">X·∫øp L·ªãch H·ªçc</h3><p class="text-sm text-gray-400 mb-6">S·∫Øp ra m·∫Øt.</p></div>
                    <div class="glass p-6 rounded-3xl opacity-50 grayscale cursor-not-allowed"><div class="w-14 h-14 rounded-2xl bg-gray-700 flex items-center justify-center text-white text-2xl mb-4"><i class="fa-solid fa-chart-pie"></i></div><h3 class="text-xl font-bold text-white mb-2">T√≠nh ƒêi·ªÉm GPA</h3><p class="text-sm text-gray-400 mb-6">S·∫Øp ra m·∫Øt.</p></div>
                </div>
                <div class="max-w-5xl mx-auto">
                    <div class="glass rounded-2xl overflow-hidden border border-white/10">
                        <div class="p-5 border-b border-white/10 flex items-center gap-3">
                            <h3 class="font-bold text-lg text-white"><i class="fa-solid fa-clock-rotate-left mr-2 text-indigo-400"></i>L·ªãch S·ª≠ Ho·∫°t ƒê·ªông</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-500 uppercase bg-black/20"><tr><th class="px-6 py-4">Th·ªùi gian</th><th class="px-6 py-4">D·ªãch v·ª•</th><th class="px-6 py-4">K·∫øt qu·∫£</th><th class="px-6 py-4">Tr·∫°ng th√°i</th></tr></thead>
                                <tbody id="client-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="admin-panel" class="hidden">
                <div class="mb-8 flex items-center justify-between">
                    <div><h2 class="text-3xl font-bold text-white mb-2">B·∫£ng Qu·∫£n Tr·ªã</h2><p class="text-gray-400 text-sm">Trung t√¢m ƒëi·ªÅu h√†nh DTU TOOL (D·ªØ li·ªáu th·ª±c).</p></div>
                    <div class="px-4 py-2 bg-rose-500/20 border border-rose-500/50 rounded-lg text-rose-400 text-xs font-bold uppercase animate-pulse"><i class="fa-solid fa-circle text-[8px] mr-2"></i> Tr·ª±c tuy·∫øn</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="glass p-5 rounded-2xl border-l-4 border-rose-500"><div class="text-xs text-gray-400 font-bold uppercase mb-1">Th√†nh Vi√™n</div><div class="text-2xl font-bold text-white" id="stat-users">0</div></div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-blue-500"><div class="text-xs text-gray-400 font-bold uppercase mb-1">ƒê∆°n H√†ng M·ªõi</div><div class="text-2xl font-bold text-white" id="stat-orders">0</div></div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-yellow-500"><div class="text-xs text-gray-400 font-bold uppercase mb-1">Ch·ªù Duy·ªát</div><div class="text-2xl font-bold text-white" id="stat-pending">0</div></div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-green-500"><div class="text-xs text-gray-400 font-bold uppercase mb-1">Doanh Thu</div><div class="text-2xl font-bold text-white" id="stat-revenue">0ƒë</div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass rounded-2xl overflow-hidden border border-white/10 h-fit">
                        <div class="p-5 border-b border-white/10 flex justify-between items-center">
                            <h3 class="font-bold text-lg"><i class="fa-solid fa-users mr-2 text-indigo-400"></i>Th√†nh Vi√™n</h3>
                            <button onclick="openUserListModal()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded transition font-bold text-white">Qu·∫£n l√Ω t·∫•t c·∫£</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-500 uppercase bg-black/20">
                                    <tr>
                                        <th class="px-6 py-4">T√†i kho·∫£n</th>
                                        <th class="px-6 py-4">G√≥i</th>
                                        <th class="px-6 py-4">Tr·∫°ng th√°i</th>
                                        <th class="px-6 py-4">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="glass rounded-2xl overflow-hidden border border-white/10 h-fit">
                        <div class="p-5 border-b border-white/10 flex justify-between items-center">
                            <h3 class="font-bold text-lg"><i class="fa-solid fa-list-check mr-2 text-green-400"></i>ƒê∆°n H√†ng D·ªãch V·ª•</h3>
                            <span class="text-xs text-gray-500">C·∫≠p nh·∫≠t tr·ª±c ti·∫øp</span>
                        </div>
                        <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scroll">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-500 uppercase bg-black/20 sticky top-0 backdrop-blur-md">
                                    <tr>
                                        <th class="px-4 py-3">Kh√°ch</th>
                                        <th class="px-4 py-3">D·ªãch v·ª•</th>
                                        <th class="px-4 py-3">Chi ti·∫øt</th>
                                        <th class="px-4 py-3">TT</th>
                                    </tr>
                                </thead>
                                <tbody id="order-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Modal Chi Ti·∫øt ƒê∆°n H√†ng -->
    <div id="order-detail-modal" class="fixed inset-0 z-[65] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm cursor-pointer" onclick="closeOrderDetailModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg px-4 modal-enter z-[75]">
            <div class="glass rounded-2xl overflow-hidden shadow-2xl border border-green-500/30">
                <div class="p-5 border-b border-white/10 flex justify-between items-center bg-gray-900/50">
                    <h3 class="text-lg font-bold text-white"><i class="fa-solid fa-clipboard-list mr-2 text-green-400"></i>Chi Ti·∫øt ƒê∆°n H√†ng</h3>
                    <button onclick="closeOrderDetailModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6">
                    <div class="flex justify-between mb-4 text-sm"><span class="text-gray-400">Kh√°ch h√†ng:</span><span class="text-white font-bold" id="detail-user">...</span></div>
                    <div class="mb-4 p-3 rounded-lg text-center font-bold text-sm" id="detail-plan-status"></div>
                    <div class="bg-indigo-500/10 p-3 rounded-xl mb-4 border border-indigo-500/20">
                        <div class="flex items-center gap-2 mb-2 text-xs font-bold text-indigo-400 uppercase"><i class="fa-solid fa-key"></i> Th√¥ng tin ƒëƒÉng nh·∫≠p MyDTU</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><div class="text-[10px] text-gray-500 uppercase">T√†i kho·∫£n</div><div class="text-white font-mono text-sm bg-black/20 p-1.5 rounded select-all" id="detail-dtu-user">...</div></div>
                            <div><div class="text-[10px] text-gray-500 uppercase">M·∫≠t kh·∫©u</div><div class="text-white font-mono text-sm bg-black/20 p-1.5 rounded select-all" id="detail-dtu-pass">...</div></div>
                        </div>
                    </div>
                    <div id="admin-log-section" class="mb-5 hidden">
                        <div class="text-xs font-bold text-cyan-400 uppercase mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-terminal"></i> Log Server (Ch·ªâ Admin)
                        </div>
                        <div class="bg-black/40 rounded-xl p-4 max-h-60 overflow-y-auto custom-scroll font-mono text-xs leading-relaxed text-gray-300" id="detail-live-log">
                            Ch∆∞a c√≥ log...
                        </div>
                    </div>
                    <div class="bg-black/30 rounded-xl p-4 mb-6 max-h-[300px] overflow-y-auto custom-scroll">
                        <div class="text-xs font-bold text-yellow-400 uppercase mb-3">K·∫øt qu·∫£ ƒëƒÉng k√Ω t·ª´ng l·ªõp</div>
                        <table class="w-full text-xs text-left">
                            <thead class="text-gray-500 uppercase border-b border-white/10">
                                <tr><th class="py-2">M√£ L·ªõp</th><th class="py-2 text-right">Tr·∫°ng th√°i</th></tr>
                            </thead>
                            <tbody id="detail-items" class="text-gray-300"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="rerunOrder()" id="btn-rerun" class="col-span-2 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl text-white font-bold text-sm shadow-lg border border-blue-400/30 transition transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-rotate-right"></i> CH·∫†Y L·∫†I TOOL
                        </button>
                        <button onclick="updateOrderStatus('completed')" id="btn-complete" class="py-3 bg-emerald-600/20 hover:bg-emerald-600 border border-emerald-500/50 rounded-xl text-emerald-400 hover:text-white font-bold text-xs transition">Ho√†n t·∫•t ƒë∆°n</button>
                        <button onclick="updateOrderStatus('cancelled')" id="btn-cancel" class="py-3 bg-gray-700/50 hover:bg-gray-600 border border-gray-600 rounded-xl text-gray-400 hover:text-white font-bold text-xs transition">H·ªßy ƒë∆°n</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Tool -->
    <div id="tool-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm cursor-pointer" onclick="closeToolModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl px-4 modal-enter z-50">
            <div class="glass rounded-2xl p-6 md:p-8">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="fa-solid fa-sliders text-indigo-400"></i> C·∫•u h√¨nh Auto</h3><button onclick="closeToolModal()" class="w-8 h-8 rounded-full bg-gray-700 hover:text-white flex items-center justify-center cursor-pointer"><i class="fa-solid fa-xmark"></i></button></div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-400 block mb-1">T√†i kho·∫£n DTU</label><input type="text" id="tool-dtu-user" class="input-field py-2 text-sm" placeholder="Nh·∫≠p t√†i kho·∫£n..."></div>
                        <div><label class="text-xs font-bold text-gray-400 block mb-1">M·∫≠t kh·∫©u DTU</label><input type="password" id="tool-dtu-pass" class="input-field py-2 text-sm" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."></div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">M√£ L·ªõp (M·ªói m√£ 1 d√≤ng ho·∫∑c c√°ch nhau d·∫•u ph·∫©y)</label>
                        <textarea id="tool-codes" class="input-field py-2 h-24 font-mono text-sm text-yellow-300" placeholder="ENG267....013&#10;ENG117....149"></textarea>
                    </div>
                    <button onclick="runSimulation()" id="btn-run" class="w-full btn-glow py-3 rounded-xl font-bold text-white shadow-lg cursor-pointer">CH·∫†Y NGAY</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Qu·∫£n L√Ω Th√†nh Vi√™n -->
    <div id="user-list-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm cursor-pointer" onclick="closeUserListModal()"></div>
        <div class="absolute top-1/2 left-1/2 w-[90%] max-w-4xl h-[80vh] modal-enter origin-center transform -translate-x-1/2 -translate-y-1/2 z-50">
            <div class="glass rounded-2xl overflow-hidden shadow-2xl border border-indigo-500/30 flex flex-col h-full">
                <div class="p-5 border-b border-white/10 flex justify-between items-center bg-gray-900/50">
                    <h3 class="text-xl font-bold text-white">Qu·∫£n L√Ω Th√†nh Vi√™n</h3>
                    <button onclick="closeUserListModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto custom-scroll p-0">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-500 uppercase bg-black/30 sticky top-0 backdrop-blur-md">
                            <tr><th class="px-6 py-4">ID</th><th class="px-6 py-4">T√†i kho·∫£n</th><th class="px-6 py-4">G√≥i</th><th class="px-6 py-4">H·∫øt h·∫°n</th><th class="px-6 py-4">Tr·∫°ng th√°i</th><th class="px-6 py-4">Thao t√°c</th></tr>
                        </thead>
                        <tbody id="full-user-table-body" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Qu·∫£n L√Ω T√†i Kho·∫£n -->
    <div id="action-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm cursor-pointer" onclick="closeActionModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm px-4 modal-enter z-[70]">
            <div class="glass rounded-2xl overflow-hidden shadow-2xl border border-indigo-500/50">
                <div class="p-6">
                    <div class="text-center mb-6"><h3 class="text-lg font-bold text-white">Qu·∫£n l√Ω t√†i kho·∫£n</h3><p class="text-xs text-gray-400 mt-1">User: <span id="action-username" class="text-white font-bold">...</span></p></div>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="grantAccess(1)" class="py-3 bg-white/5 hover:bg-indigo-600 rounded-xl border border-white/10 text-xs font-bold text-white transition">K√≠ch ho·∫°t 1 Ng√†y</button>
                        <button onclick="grantAccess(30)" class="py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl border border-white/10 text-xs font-bold text-white shadow-lg shadow-indigo-500/30 transition">K√≠ch ho·∫°t VIP (30 ng√†y)</button>
                        <button onclick="revokeVip()" class="py-3 bg-orange-600/20 hover:bg-orange-600 border border-orange-500/50 rounded-xl text-orange-400 hover:text-white font-bold text-xs transition">H·ª¶Y G√ìI VIP</button>
                        <button onclick="toggleBlock()" id="block-btn" class="py-3 bg-red-500/10 hover:bg-red-600 border border-red-500/30 rounded-xl text-red-400 hover:text-white text-xs font-bold transition">KH√ìA T√ÄI KHO·∫¢N</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Y√™u C·∫ßu VIP -->
    <div id="payment-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md cursor-pointer" onclick="closePaymentModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md px-4 modal-enter z-[70]">
            <div class="glass rounded-2xl overflow-hidden shadow-2xl border border-yellow-500/50">
                <div class="p-8 text-center">
                    <div class="w-20 h-20 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-yellow-500/20"><i class="fa-solid fa-crown text-4xl text-yellow-500 animate-pulse"></i></div>
                    <h2 class="text-2xl font-bold text-white mb-2">T√≠nh NƒÉng VIP</h2>
                    <p class="text-gray-300 text-sm mb-6">B·∫°n c·∫ßn n√¢ng c·∫•p t√†i kho·∫£n ƒë·ªÉ s·ª≠ d·ª•ng Auto.<br>Vui l√≤ng li√™n h·ªá Admin ƒë·ªÉ k√≠ch ho·∫°t.</p>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10 mb-6 text-left">
                        <div class="text-xs text-gray-500 font-bold uppercase mb-2">Li√™n h·ªá Admin:</div>
                        <a href="https://www.facebook.com/PhamHoangVngw" target="_blank" class="flex items-center gap-3 p-2 hover:bg-white/5 rounded transition cursor-pointer"><i class="fa-brands fa-facebook text-blue-500 text-xl"></i><span class="text-white font-bold text-sm">PhamHoangVngw</span></a>
                        <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded transition cursor-pointer" onclick="copyZalo()"><i class="fa-solid fa-phone text-green-500 text-xl"></i><span class="text-white font-bold text-sm">0795616819 (Zalo)</span></div>
                    </div>
                    <button onclick="closePaymentModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition cursor-pointer">ƒê·ªÉ sau</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyC1Ss3l4PTjPy_nKQkL503iGp2j6xfvE",
            authDomain: "myweddtutool.firebaseapp.com",
            projectId: "myweddtutool",
            storageBucket: "myweddtutool.appspot.com",
            messagingSenderId: "83985574900",
            appId: "1:83985574900:web:d088d1883579263c7e721",
            measurementId: "G-4Y7S27YXYY"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const PRICE_VIP = 150000;
        let usersDB = [];
        let ordersDB = [];
        let currentUser = null;
        let selectedUserId = null;
        let selectedOrderId = null;
        let pollingInterval = null;
        let lastLog = '';

        function getStatusBadge(status) {
            switch (status) {
                case 'done':
                    return '<span class="status-badge st-done"><i class="fa-solid fa-check"></i> Ho√†n t·∫•t</span>';
                case 'processing':
                    return '<span class="status-badge st-process"><i class="fa-solid fa-spinner"></i> ƒêang x·ª≠ l√Ω</span>';
                case 'hanging':
                    return '<span class="status-badge st-hanging"><i class="fa-solid fa-plug-circle-exclamation"></i> ƒêang b·ªã treo</span>';
                default:
                    return '<span class="status-badge st-error"><i class="fa-solid fa-times"></i> Th·∫•t b·∫°i</span>';
            }
        }

        async function loadData() {
            try {
                const usersSnap = await db.collection('users').get();
                usersDB = usersSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                const ordersSnap = await db.collection('orders').get();
                ordersDB = ordersSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if (!usersDB.find(x => x.user === 'admin')) {
                    const adminUser = {
                        user: 'admin',
                        pass: 'Hoangvuonglop5d@',
                        role: 'ADMIN',
                        status: 'active',
                        exp: 'Vƒ©nh vi·ªÖn'
                    };
                    await db.collection('users').doc('admin').set(adminUser);
                    usersDB.push(adminUser);
                }
                checkSession();
            } catch (err) {
                console.error('L·ªói load Firebase:', err);
                showToast('L·ªói', 'Kh√¥ng k·∫øt n·ªëi Firebase', 'error');
            }
        }

        async function saveData() {
            try {
                const batch = db.batch();
                usersDB.forEach(user => batch.set(db.collection('users').doc(user.user), user));
                ordersDB.forEach(order => batch.set(db.collection('orders').doc(order.id.toString()), order));
                await batch.commit();
                if (currentUser && currentUser.role !== 'ADMIN') renderClientOrders();
                if (currentUser.role === 'ADMIN') { renderUserTable(); renderOrderTable(); renderStats(); }
            } catch (err) { console.error('L·ªói l∆∞u:', err); }
        }

        function checkSession() {
            const savedUser = localStorage.getItem('current_user_session');
            if (savedUser) {
                const userObj = usersDB.find(u => u.user === savedUser);
                if (userObj && userObj.status !== 'blocked') {
                    currentUser = userObj;
                    enterSystem();
                }
            }
        }

        function logout() {
            if (pollingInterval) clearInterval(pollingInterval);
            localStorage.removeItem('current_user_session');
            location.reload();
        }

        function handleRegister() {
            const u = document.getElementById('reg-user').value.trim();
            const p = document.getElementById('reg-pass').value.trim();
            if (!u || !p) { showToast('L·ªói', 'Nh·∫≠p ƒë·ªß th√¥ng tin!', 'error'); return; }
            if (usersDB.find(x => x.user === u)) { showToast('L·ªói', 'T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!', 'error'); return; }
            const newUser = { user: u, pass: p, role: 'Free', status: 'pending', exp: '-' };
            usersDB.push(newUser);
            saveData();
            showToast('Th√†nh c√¥ng', 'ƒêƒÉng k√Ω OK!', 'success');
            switchAuthTab('login');
            document.getElementById('login-user').value = u;
        }

        function handleLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if (!u || !p) { showToast('L·ªói', 'Nh·∫≠p ƒë·ªß th√¥ng tin!', 'error'); return; }
            const userObj = usersDB.find(x => x.user === u && x.pass === p);
            if (!userObj) { showToast('L·ªói', 'Sai t√†i kho·∫£n/m·∫≠t kh·∫©u!', 'error'); return; }
            if (userObj.status === 'blocked') { showToast('B·ªã kh√≥a', 'T√†i kho·∫£n ƒë√£ b·ªã kh√≥a!', 'error'); return; }
            localStorage.setItem('current_user_session', u);
            currentUser = userObj;
            showToast('ƒêƒÉng nh·∫≠p', 'Ch√†o m·ª´ng!', 'success');
            setTimeout(enterSystem, 1000);
        }

        function enterSystem() {
            document.getElementById('view-auth').style.opacity = '0';
            document.getElementById('view-auth').style.display = 'none';
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-dashboard').style.opacity = '1';
            document.getElementById('display-name').innerText = currentUser.user;
            const pb = document.getElementById('user-plan-badge'), sb = document.getElementById('user-status-badge');
            if (currentUser.role === 'ADMIN') {
                pb.innerText = 'QU·∫¢N TR·ªä VI√äN'; pb.className = 'text-[10px] px-2 py-0.5 rounded bg-rose-500/20 text-rose-300 font-bold border border-rose-500/30';
                sb.innerText = 'TO√ÄN QUY·ªÄN'; sb.className = 'text-[10px] px-2 py-0.5 rounded bg-rose-500/20 text-rose-400 font-bold border border-rose-500/30';
            } else if (currentUser.role === 'PRO') {
                pb.innerText = 'G√ìI VIP'; pb.className = 'text-[10px] px-2 py-0.5 rounded bg-indigo-500/20 text-indigo-300 font-bold border border-indigo-500/30';
                sb.innerText = 'HO·∫†T ƒê·ªòNG'; sb.className = 'text-[10px] px-2 py-0.5 rounded bg-green-500/20 text-green-400 font-bold border border-green-500/30';
            } else {
                pb.innerText = 'MI·ªÑN PH√ç'; pb.className = 'text-[10px] px-2 py-0.5 rounded bg-gray-700 text-gray-400 font-bold border border-white/10';
                sb.innerText = 'CH∆ØA K√çCH HO·∫†T'; sb.className = 'text-[10px] px-2 py-0.5 rounded bg-yellow-500/10 text-yellow-500 font-bold border border-yellow-500/20';
            }
            if (currentUser.role === 'ADMIN') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('client-panel').classList.add('hidden');
                document.getElementById('nav-logo').classList.replace('bg-indigo-600', 'admin-bg');
                document.getElementById('nav-role').innerText = "B·∫¢NG QU·∫¢N TR·ªä";
                document.getElementById('nav-role').classList.replace('text-indigo-300', 'text-rose-300');
                renderUserTable(); renderOrderTable(); renderStats();
            } else {
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('client-panel').classList.remove('hidden');
                renderClientOrders();
            }
            if (currentUser.role !== 'ADMIN') {
                const hideUntil = localStorage.getItem('welcome_hidden_until');
                if (!hideUntil || Date.now() > parseInt(hideUntil)) {
                    setTimeout(() => document.getElementById('welcome-modal').classList.add('show'), 800);
                }
            }
            startRealTimePolling();
        }

        function renderClientOrders() {
            const tbody = document.getElementById('client-history-body');
            tbody.innerHTML = '';
            const myOrders = ordersDB.filter(o => o.user === currentUser.user).sort((a, b) => b.id - a.id);
            if (myOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500 italic">Ch∆∞a c√≥ ƒë∆°n h√†ng</td></tr>';
                return;
            }
            myOrders.forEach(o => {
                let resultText = o.items.length + ' l·ªõp';
                if (o.status === 'done') {
                    const successCount = o.items.filter(i => i.status === 'success').length;
                    resultText = `<strong>${successCount}/${o.items.length}</strong> th√†nh c√¥ng`;
                }
                tbody.innerHTML += `
                <tr class="table-row" onclick="viewOrderDetails('${o.id}')">
                    <td class="px-6 py-4 font-mono text-white">${o.time}</td>
                    <td class="px-6 py-4 text-xs font-bold text-indigo-300">ƒêƒÉng K√Ω T√≠n Ch·ªâ</td>
                    <td class="px-6 py-4 text-white">${resultText}</td>
                    <td class="px-6 py-4">${getStatusBadge(o.status)}</td>
                </tr>`;
            });
        }

        function renderUserTable() {
            const tbody = document.getElementById('user-table-body');
            const fullTbody = document.getElementById('full-user-table-body');
            tbody.innerHTML = '';
            if (fullTbody) fullTbody.innerHTML = '';
            const sortedUsers = [...usersDB].sort((a, b) => (a.status === 'pending' ? -1 : 1));
            sortedUsers.forEach((u, idx) => {
                let stCls = 'st-success', stText = 'Ho·∫°t ƒë·ªông', stIcon = 'fa-check-circle';
                if (u.status === 'blocked') { stCls = 'st-error'; stText = 'ƒê√£ kh√≥a'; stIcon = 'fa-ban'; }
                else if (u.status === 'pending') { stCls = 'st-pending'; stText = 'Ch·ªù duy·ªát'; stIcon = 'fa-clock'; }
                if (idx < 5) {
                    tbody.innerHTML += `<tr class="table-row">
                        <td class="px-6 py-4 font-bold text-white">${u.user}</td>
                        <td class="px-6 py-4 ${u.role === 'PRO' ? 'text-indigo-400 font-bold' : ''}">${u.role}</td>
                        <td class="px-6 py-4"><span class="status-badge ${stCls}"><i class="fa-solid ${stIcon}"></i> ${stText}</span></td>
                        <td class="px-6 py-4">${u.role !== 'ADMIN' ? `<button onclick="openActionMenu('${u.user}')" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition"><i class="fa-solid fa-ellipsis-vertical"></i></button>` : ''}</td>
                    </tr>`;
                }
                if (fullTbody) {
                    fullTbody.innerHTML += `<tr class="table-row">
                        <td class="px-6 py-4 text-xs">#${u.user}</td>
                        <td class="px-6 py-4 font-bold text-white">${u.user}</td>
                        <td class="px-6 py-4 text-indigo-300">${u.role}</td>
                        <td class="px-6 py-4 text-xs font-mono">${u.exp}</td>
                        <td class="px-6 py-4"><span class="status-badge ${stCls}"><i class="fa-solid ${stIcon}"></i> ${stText}</span></td>
                        <td class="px-6 py-4">${u.role !== 'ADMIN' ? `<button onclick="openActionMenu('${u.user}')" class="text-xs bg-indigo-500/20 hover:bg-indigo-500 text-indigo-400 hover:text-white px-3 py-1 rounded transition">Qu·∫£n l√Ω</button>` : '<span class="text-xs text-gray-600">Admin</span>'}</td>
                    </tr>`;
                }
            });
        }

        function renderOrderTable() {
            const tbody = document.getElementById('order-table-body');
            tbody.innerHTML = '';
            ordersDB.forEach(o => {
                tbody.innerHTML += `
                <tr class="table-row">
                    <td class="px-4 py-3 font-bold text-white">${o.user}</td>
                    <td class="px-4 py-3 text-xs">ƒêƒÉng K√Ω T√≠n Ch·ªâ</td>
                    <td class="px-4 py-3"><button onclick="viewOrderDetails('${o.id}')" class="text-xs text-indigo-400 hover:text-white underline">Chi ti·∫øt</button></td>
                    <td class="px-4 py-3">${getStatusBadge(o.status)}</td>
                </tr>`;
            });
        }

        function renderStats() {
            const proUsers = usersDB.filter(u => u.role === 'PRO').length;
            const revenue = proUsers * PRICE_VIP;
            const pending = usersDB.filter(u => u.status === 'pending').length;
            document.getElementById('stat-users').innerText = usersDB.length;
            document.getElementById('stat-orders').innerText = ordersDB.length;
            document.getElementById('stat-pending').innerText = pending;
            document.getElementById('stat-revenue').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(revenue).replace('‚Ç´', 'ƒë');
        }

        function runSimulation() {
            let dtuUser = document.getElementById('tool-dtu-user').value.trim();
            let dtuPass = document.getElementById('tool-dtu-pass').value;
            let codes = document.getElementById('tool-codes').value.replace(/\n/g, ",").trim();
            if (currentUser.role !== 'ADMIN' && currentUser.role !== 'PRO') {
                document.getElementById('payment-modal').classList.remove('hidden');
                return;
            }
            if (!dtuUser || !dtuPass || !codes) {
                showToast('L·ªói', 'Nh·∫≠p ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            const newOrder = {
                id: Date.now(),
                user: currentUser.user,
                dtuUser: dtuUser,
                dtuPass: dtuPass,
                service: 'T√≠n Ch·ªâ Auto',
                items: codes.split(',').map(c => ({ code: c.trim(), status: 'pending', message: 'Ch·ªù server x·ª≠ l√Ω...' })),
                status: 'processing',
                time: new Date().toLocaleTimeString(),
                fullLog: ''
            };
            ordersDB.unshift(newOrder);
            saveData();
            renderClientOrders();
            if (currentUser.role === 'ADMIN') renderOrderTable();
            showToast('ƒê√£ g·ª≠i', 'ƒê∆°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn server...', 'success');
            closeToolModal();
            fetch('https://lying-iso-could-situated.trycloudflare.com/run-auto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: dtuUser, pass: dtuPass, codes: codes })
            })
            .then(r => r.json())
            .then(data => {
                showToast('Server', data.status === 'success' ? 'Tool b·∫Øt ƒë·∫ßu ch·∫°y!' : 'L·ªói kh·ªüi ƒë·ªông', data.status === 'success' ? 'success' : 'error');
            })
            .catch(() => {
                newOrder.status = 'hanging';
                saveData();
                renderClientOrders();
                if (currentUser.role === 'ADMIN') renderOrderTable();
                showToast('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server ‚Üí ƒê∆°n b·ªã treo', 'error');
            });
        }

        function rerunOrder() {
            if (!hasPermissionToControlOrder()) {
                showToast('Kh√¥ng c√≥ quy·ªÅn', 'Ch·ªâ VIP ho·∫∑c Admin ƒë∆∞·ª£c ch·∫°y l·∫°i!', 'error');
                return;
            }
            const order = ordersDB.find(o => o.id === selectedOrderId);
            if (!order) return;
            order.items.forEach(item => { item.status = 'pending'; item.message = 'ƒêang x·ª≠ l√Ω...'; });
            order.status = 'processing';
            order.time = new Date().toLocaleTimeString();
            delete order.fullLog;
            saveData();
            renderOrderTable();
            renderClientOrders();
            showToast('ƒê√£ g·ª≠i', 'Ch·∫°y l·∫°i tool...', 'process');
            fetch('https://lying-iso-could-situated.trycloudflare.com/run-auto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: order.dtuUser, pass: order.dtuPass, codes: order.items.map(i => i.code).join(',') })
            })
            .then(r => r.json())
            .then(data => {
                showToast('Server', data.status === 'success' ? 'ƒêang ch·∫°y l·∫°i!' : 'L·ªói server', data.status === 'success' ? 'success' : 'error');
            })
            .catch(() => {
                order.status = 'hanging';
                saveData();
                renderOrderTable();
                renderClientOrders();
                showToast('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server ‚Üí ƒê∆°n b·ªã treo', 'error');
            });
        }

        function updateOrderStatus(newStatus) {
            if (newStatus === 'completed' && !hasPermissionToControlOrder()) {
                showToast('Kh√¥ng c√≥ quy·ªÅn', 'Ch·ªâ VIP ho·∫∑c Admin ƒë∆∞·ª£c ho√†n t·∫•t!', 'error');
                return;
            }
            const order = ordersDB.find(o => o.id === selectedOrderId);
            if (!order) return;
            order.status = newStatus === 'completed' ? 'done' : 'cancelled';
            saveData();
            renderOrderTable();
            renderClientOrders();
            showToast('Th√†nh c√¥ng', newStatus === 'completed' ? 'ƒê∆°n ho√†n t·∫•t' : 'ƒê∆°n ƒë√£ h·ªßy', 'success');
            closeOrderDetailModal();
        }

        function viewOrderDetails(id) {
            selectedOrderId = id;
            const order = ordersDB.find(x => x.id === id);
            if (!order) return;
            document.getElementById('detail-user').innerText = order.user;
            document.getElementById('detail-dtu-user').innerText = order.dtuUser || 'Kh√¥ng c√≥';
            document.getElementById('detail-dtu-pass').innerText = order.dtuPass || 'Kh√¥ng c√≥';
            const customer = usersDB.find(u => u.user === order.user);
            const planStatusEl = document.getElementById('detail-plan-status');
            if (customer && customer.role === 'PRO' && customer.status === 'active') {
                planStatusEl.innerHTML = `<i class="fa-solid fa-check-circle text-green-400 mr-2"></i><span class="text-green-400">VIP c√≤n h·∫°n (${customer.exp})</span>`;
                planStatusEl.className = 'mb-4 p-3 rounded-lg text-center font-bold text-sm bg-green-500/10 border border-green-500/30';
            } else {
                planStatusEl.innerHTML = `<i class="fa-solid fa-exclamation-triangle text-orange-400 mr-2"></i><span class="text-orange-400">H·∫øt ho·∫∑c ch∆∞a c√≥ VIP</span>`;
                planStatusEl.className = 'mb-4 p-3 rounded-lg text-center font-bold text-sm bg-orange-500/10 border border-orange-500/30';
            }
            const adminLogSection = document.getElementById('admin-log-section');
            const logEl = document.getElementById('detail-live-log');
            if (currentUser.role === 'ADMIN' && order.fullLog) {
                adminLogSection.classList.remove('hidden');
                logEl.innerHTML = order.fullLog.replace(/\n/g, '<br>');
                logEl.scrollTop = logEl.scrollHeight;
            } else {
                adminLogSection.classList.add('hidden');
            }
            const itemsDiv = document.getElementById('detail-items');
            itemsDiv.innerHTML = '';
            order.items.forEach(item => {
                const isSuccess = item.status === 'success';
                const color = isSuccess ? "text-green-400" : "text-red-400";
                const icon = isSuccess ? "fa-check-circle" : "fa-times-circle";
                const message = item.message || (isSuccess ? "ƒêƒÉng k√Ω th√†nh c√¥ng" : "ƒêang x·ª≠ l√Ω / L·ªói");
                itemsDiv.innerHTML += `
                <tr class="border-b border-white/5">
                    <td class="py-3 font-mono font-bold text-white">${item.code}</td>
                    <td class="py-3 text-right ${color}">
                        <i class="fa-solid ${icon} mr-2"></i>${message}
                    </td>
                </tr>`;
            });
            const canControl = hasPermissionToControlOrder();
            document.getElementById('btn-rerun').disabled = !canControl;
            document.getElementById('btn-rerun').classList.toggle('opacity-50', !canControl);
            document.getElementById('btn-rerun').classList.toggle('cursor-not-allowed', !canControl);
            document.getElementById('btn-complete').disabled = !canControl;
            document.getElementById('btn-complete').classList.toggle('opacity-50', !canControl);
            document.getElementById('btn-complete').classList.toggle('cursor-not-allowed', !canControl);
            document.getElementById('order-detail-modal').classList.remove('hidden');
        }

        function closeOrderDetailModal() {
            document.getElementById('order-detail-modal').classList.add('hidden');
        }

        function hasPermissionToControlOrder() {
            if (currentUser.role === 'ADMIN') return true;
            const order = ordersDB.find(o => o.id === selectedOrderId);
            if (!order) return false;
            return order.user === currentUser.user && currentUser.role === 'PRO';
        }

        function startRealTimePolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            let failCount = 0;
            pollingInterval = setInterval(async () => {
                try {
                    const res = await fetch('https://lying-iso-could-situated.trycloudflare.com/status');
                    if (!res.ok) throw new Error('Not ok');
                    failCount = 0;
                    const logText = await res.text();
                    if (logText === lastLog) return;
                    lastLog = logText;

                    const runningOrder = ordersDB.find(o => o.status === 'processing');
                    if (!runningOrder) return;

                    runningOrder.fullLog = logText;

                    const lines = logText.split('\n').reverse();
                    let currentCode = null;

                    for (const line of lines) {
                        if (line.includes('Th·ª≠ ƒëƒÉng k√Ω:') || line.includes('‚ö° Th·ª≠ ƒëƒÉng k√Ω:')) {
                            const parts = line.split(/Th·ª≠ ƒëƒÉng k√Ω:|\‚ö° Th·ª≠ ƒëƒÉng k√Ω:/);
                            if (parts.length > 1) currentCode = parts[1].trim();
                        }
                        if (line.includes('ƒêƒÇNG K√ù TH√ÄNH C√îNG!') && currentCode) {
                            const item = runningOrder.items.find(i => i.code === currentCode);
                            if (item) {
                                item.status = 'success';
                                item.message = 'ƒêƒÉng k√Ω th√†nh c√¥ng';
                            }
                        }
                        if (line.includes('HO√ÄN TH√ÄNH - ƒê√£ ƒëƒÉng k√Ω h·∫øt t·∫•t c·∫£ l·ªõp!') || line.includes('HO√ÄN T·∫§T T·∫§T C·∫¢ C√ÅC V√íNG ƒêƒÇNG K√ù') || line.includes('üèÅ HO√ÄN T·∫§T T·∫§T C·∫¢ C√ÅC V√íNG ƒêƒÇNG K√ù')) {
                            runningOrder.status = 'done';
                            runningOrder.items.forEach(item => {
                                if (item.status === 'pending') {
                                    item.status = 'error';
                                    item.message = 'L·ªói ho·∫∑c h·∫øt ch·ªó';
                                }
                            });
                            saveData();
                            renderClientOrders();
                            if (currentUser.role === 'ADMIN') renderOrderTable();
                            showToast('Ho√†n t·∫•t', 'Tool ƒë√£ ho√†n th√†nh! K·∫øt qu·∫£ ƒë√£ c·∫≠p nh·∫≠t.', 'success');
                            if (!document.getElementById('order-detail-modal').classList.contains('hidden')) {
                                viewOrderDetails(runningOrder.id);
                            }
                            break;
                        }
                    }

                    saveData();
                    renderClientOrders();
                    if (currentUser.role === 'ADMIN') renderOrderTable();

                } catch (e) {
                    failCount++;
                    const processingOrder = ordersDB.find(o => o.status === 'processing');
                    if (processingOrder && failCount >= 2) {
                        processingOrder.status = 'hanging';
                        saveData();
                        renderClientOrders();
                        if (currentUser.role === 'ADMIN') renderOrderTable();
                        showToast('C·∫£nh b√°o', 'M·∫•t k·∫øt n·ªëi server ‚Üí ƒê∆°n b·ªã treo', 'error');
                    }
                }
            }, 1500);
        }

        function openToolModal() {
            if (currentUser.role === 'PRO' || currentUser.role === 'ADMIN') {
                document.getElementById('tool-modal').classList.remove('hidden');
            } else {
                document.getElementById('payment-modal').classList.remove('hidden');
            }
        }

        function closeToolModal() {
            document.getElementById('tool-modal').classList.add('hidden');
        }

        function openUserListModal() {
            renderUserTable();
            document.getElementById('user-list-modal').classList.remove('hidden');
        }

        function closeUserListModal() {
            document.getElementById('user-list-modal').classList.add('hidden');
        }

        function openActionMenu(user) {
            selectedUserId = user;
            const u = usersDB.find(x => x.user === user);
            document.getElementById('action-username').innerText = u.user;
            const blockBtn = document.getElementById('block-btn');
            if (u.status === 'blocked') {
                blockBtn.innerText = 'M·ªû KH√ìA';
                blockBtn.className = 'py-3 bg-green-600/20 hover:bg-green-600 border border-green-500/50 rounded-xl text-green-400 hover:text-white text-xs font-bold transition';
            } else {
                blockBtn.innerText = 'KH√ìA T√ÄI KHO·∫¢N';
                blockBtn.className = 'py-3 bg-red-500/10 hover:bg-red-600 border border-red-500/30 rounded-xl text-red-400 hover:text-white text-xs font-bold transition';
            }
            document.getElementById('action-modal').classList.remove('hidden');
        }

        function closeActionModal() {
            document.getElementById('action-modal').classList.add('hidden');
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
        }

        function grantAccess(days) {
            const u = usersDB.find(x => x.user === selectedUserId);
            u.status = 'active';
            u.role = 'PRO';
            const d = new Date();
            d.setDate(d.getDate() + days);
            u.exp = d.toLocaleDateString('vi-VN');
            saveData();
            closeActionModal();
            showToast('Th√†nh c√¥ng', 'K√≠ch ho·∫°t VIP OK!', 'success');
        }

        function revokeVip() {
            const u = usersDB.find(x => x.user === selectedUserId);
            u.role = 'Free';
            u.exp = '-';
            saveData();
            closeActionModal();
            showToast('Th√†nh c√¥ng', 'H·ªßy VIP OK', 'success');
        }

        function toggleBlock() {
            const u = usersDB.find(x => x.user === selectedUserId);
            if (u.status === 'blocked') {
                u.status = 'active';
                u.role = (u.role === 'BANNED') ? 'Free' : u.role;
                showToast('Th√†nh c√¥ng', 'M·ªü kh√≥a OK', 'success');
            } else {
                u.status = 'blocked';
                u.role = 'BANNED';
                u.exp = 'ƒê√£ kh√≥a';
                showToast('Th√†nh c√¥ng', 'Kh√≥a t√†i kho·∫£n OK', 'success');
            }
            saveData();
            closeActionModal();
        }

        function hideWelcomeFor2Hours() {
            localStorage.setItem('welcome_hidden_until', (Date.now() + 2 * 60 * 60 * 1000).toString());
            closeWelcomeModal();
            showToast('ƒê√£ ·∫©n', 'Kh√¥ng hi·ªán trong 2 ti·∫øng', 'success');
        }

        function closeWelcomeModal() {
            document.getElementById('welcome-modal').classList.remove('show');
        }

        function copyZalo() {
            navigator.clipboard.writeText('0795616819');
            showToast('ƒê√£ copy', 'Zalo: 0795616819', 'success');
        }

        function switchAuthTab(tab) {
            const ind = document.getElementById('tab-indicator'), sl = document.getElementById('form-slider'), bl = document.getElementById('btn-tab-login'), br = document.getElementById('btn-tab-register');
            if (tab === 'login') {
                ind.style.left = '4px';
                sl.style.transform = 'translateX(0)';
                bl.classList.replace('text-gray-400', 'text-white');
                br.classList.replace('text-white', 'text-gray-400');
            } else {
                ind.style.left = 'calc(50% + 0px)';
                sl.style.transform = 'translateX(-50%)';
                br.classList.replace('text-gray-400', 'text-white');
                bl.classList.replace('text-white', 'text-gray-400');
            }
        }

        function showToast(t, m, type = 'success') {
            const toast = document.getElementById('toast'), bg = document.getElementById('toast-icon-bg'), icon = document.getElementById('toast-icon');
            document.getElementById('toast-title').innerText = t;
            document.getElementById('toast-msg').innerHTML = m;
            if (type === 'success') {
                toast.style.borderLeftColor = '#22c55e';
                bg.className = 'w-10 h-10 rounded-full flex items-center justify-center text-lg bg-green-500/20 text-green-400';
                icon.className = 'fa-solid fa-circle-check';
            } else if (type === 'process') {
                toast.style.borderLeftColor = '#38bdf8';
                bg.className = 'w-10 h-10 rounded-full flex items-center justify-center text-lg bg-blue-500/20 text-blue-400';
                icon.className = 'fa-solid fa-spinner fa-spin';
            } else {
                toast.style.borderLeftColor = '#f43f5e';
                bg.className = 'w-10 h-10 rounded-full flex items-center justify-center text-lg bg-red-500/20 text-red-400';
                icon.className = 'fa-solid fa-circle-exclamation';
            }
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // Particles background
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = [];
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2;
                this.speedX = Math.random() * 1 - 0.5;
                this.speedY = Math.random() * 1 - 0.5;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
                if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(100, 100, 255, 0.3)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function init() { for (let i = 0; i < 50; i++) particles.push(new Particle()); }
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        init(); animate();
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

        // C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI ƒê∆†N REALTIME T·ª™ LOG SERVER
        function startRealTimePolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            let failCount = 0;
            pollingInterval = setInterval(async () => {
                try {
                    const res = await fetch('https://lying-iso-could-situated.trycloudflare.com/status');
                    if (!res.ok) throw new Error('Not ok');
                    failCount = 0;
                    const logText = await res.text();
                    if (logText === lastLog) return;
                    lastLog = logText;

                    const runningOrder = ordersDB.find(o => o.status === 'processing');
                    if (!runningOrder) return;

                    runningOrder.fullLog = logText;

                    const lines = logText.split('\n').reverse();
                    let currentCode = null;

                    for (const line of lines) {
                        if (line.includes('Th·ª≠ ƒëƒÉng k√Ω:') || line.includes('‚ö° Th·ª≠ ƒëƒÉng k√Ω:')) {
                            const parts = line.split(/Th·ª≠ ƒëƒÉng k√Ω:|\‚ö° Th·ª≠ ƒëƒÉng k√Ω:/);
                            if (parts.length > 1) currentCode = parts[1].trim();
                        }
                        if (line.includes('ƒêƒÇNG K√ù TH√ÄNH C√îNG!') && currentCode) {
                            const item = runningOrder.items.find(i => i.code === currentCode);
                            if (item) {
                                item.status = 'success';
                                item.message = 'ƒêƒÉng k√Ω th√†nh c√¥ng';
                            }
                        }
                        if (line.includes('HO√ÄN TH√ÄNH - ƒê√£ ƒëƒÉng k√Ω h·∫øt t·∫•t c·∫£ l·ªõp!') || line.includes('HO√ÄN T·∫§T T·∫§T C·∫¢ C√ÅC V√íNG ƒêƒÇNG K√ù') || line.includes('üèÅ HO√ÄN T·∫§T T·∫§T C·∫¢ C√ÅC V√íNG ƒêƒÇNG K√ù')) {
                            runningOrder.status = 'done';
                            runningOrder.items.forEach(item => {
                                if (item.status === 'pending') {
                                    item.status = 'error';
                                    item.message = 'L·ªói ho·∫∑c h·∫øt ch·ªó';
                                }
                            });
                            saveData();
                            renderClientOrders();
                            if (currentUser.role === 'ADMIN') renderOrderTable();
                            showToast('Ho√†n t·∫•t', 'Tool ƒë√£ ho√†n th√†nh! K·∫øt qu·∫£ ƒë√£ c·∫≠p nh·∫≠t.', 'success');
                            if (!document.getElementById('order-detail-modal').classList.contains('hidden')) {
                                viewOrderDetails(runningOrder.id);
                            }
                            break;
                        }
                    }

                    saveData();
                    renderClientOrders();
                    if (currentUser.role === 'ADMIN') renderOrderTable();

                } catch (e) {
                    failCount++;
                    const processingOrder = ordersDB.find(o => o.status === 'processing');
                    if (processingOrder && failCount >= 2) {
                        processingOrder.status = 'hanging';
                        saveData();
                        renderClientOrders();
                        if (currentUser.role === 'ADMIN') renderOrderTable();
                        showToast('C·∫£nh b√°o', 'M·∫•t k·∫øt n·ªëi server ‚Üí ƒê∆°n b·ªã treo', 'error');
                    }
                }
            }, 1500);
        }

        loadData();
    </script>
</body>
</html>
